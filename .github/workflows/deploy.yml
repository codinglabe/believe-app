name: Deploy Laravel to cPanel

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      PHP_VERSION: '8.3'
      DEPLOY_HOST: 501c3ers.com          # CHANGE
      DEPLOY_USER: c3ers          # CHANGE
      DEPLOY_PATH: /home/c3ers/public_html  # CHANGE
      SSH_PORT: 22                      # CHANGE IF NEEDED

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer:v2
          extensions: mbstring, intl, bcmath, ctype, curl, dom, fileinfo, json, openssl, pdo, pdo_mysql, tokenizer, xml

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache/files
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install Dependencies
        run: |
          composer install --no-dev --prefer-dist --no-interaction --optimize-autoloader
          mkdir -p resources/views storage/framework/views
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache

      - name: Setup Node (if needed)
        if: hashFiles('package.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build Assets
        if: hashFiles('package.json') != ''
        run: |
          npm ci --legacy-peer-deps
          npm run build

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.CPANEL_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ env.SSH_PORT }} -H ${{ env.DEPLOY_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Deploy via rsync
        run: |
          rsync -avz --delete \
            -e "ssh -p ${{ env.SSH_PORT }} -o StrictHostKeyChecking=no" \
            --exclude='.git*' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='tests' \
            --exclude='storage/logs/*.log' \
            --exclude='.env' \
            . ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }}:${{ env.DEPLOY_PATH }}/

      - name: Post-Deploy Permissions & Cache
        run: |
          ssh -p ${{ env.SSH_PORT }} ${{ env.DEPLOY_USER }}@${ env.DEPLOY_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}

            # Permissions
            find . -type f -exec chmod 644 {} \;
            find . -type d -exec chmod 755 {} \;
            chmod -R 775 storage bootstrap/cache

            # Clear & recache
            php artisan config:clear
            php artisan route:clear
            php artisan view:clear
            php artisan cache:clear

            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            # Create .env if missing
            [ ! -f .env ] && cp .env.example .env && php artisan key:generate --force

            echo "Deployed & ready!"
          EOF