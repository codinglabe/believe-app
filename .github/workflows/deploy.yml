name: Deploy Laravel to cPanel

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      PHP_VERSION: '8.3'
      DEPLOY_HOST: 501c3ers.com
      DEPLOY_USER: c3ers
      DEPLOY_PATH: /home/c3ers/public_html
      SSH_PORT: 22

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer:v2
          extensions: mbstring, intl, bcmath, ctype, curl, dom, fileinfo, json, openssl, pdo, pdo_mysql, tokenizer, xml

      - name: Install Dependencies
        run: |
          composer install --no-dev --prefer-dist --no-interaction --optimize-autoloader
          mkdir -p resources/views storage/framework/views
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache

      - name: Build Assets
        if: hashFiles('package.json') != ''
        run: |
          npm ci --legacy-peer-deps
          npm run build

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.CPANEL_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ env.SSH_PORT }} -H ${{ env.DEPLOY_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Test SSH Connection
        run: |
          ssh -p ${{ env.SSH_PORT }} -o StrictHostKeyChecking=no ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} "echo 'SSH OK'"

      - name: Check Storage Folder Exists
        id: check_storage
        run: |
          STORAGE_EXISTS=$(ssh -p ${{ env.SSH_PORT }} -o StrictHostKeyChecking=no ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} "test -d ${{ env.DEPLOY_PATH }}/storage && echo 'yes' || echo 'no'")
          echo "storage_exists=$STORAGE_EXISTS" >> $GITHUB_OUTPUT
          echo "Storage folder exists: $STORAGE_EXISTS"

      - name: Deploy (Conditional Storage)
        run: |
          if [ "${{ steps.check_storage.outputs.storage_exists }}" == "yes" ]; then
            echo "Storage folder exists on server, excluding from upload"
            rsync -avz --delete \
              -e "ssh -p ${{ env.SSH_PORT }} -o StrictHostKeyChecking=no" \
              --exclude='.git*' \
              --exclude='.github' \
              --exclude='node_modules' \
              --exclude='tests' \
              --exclude='.env' \
              --exclude='.env.*' \
              --exclude='storage/' \
              . ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }}:${{ env.DEPLOY_PATH }}/
          else
            echo "Storage folder does not exist on server, will upload it"
            rsync -avz --delete \
              -e "ssh -p ${{ env.SSH_PORT }} -o StrictHostKeyChecking=no" \
              --exclude='.git*' \
              --exclude='.github' \
              --exclude='node_modules' \
              --exclude='tests' \
              --exclude='.env' \
              --exclude='.env.*' \
              . ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }}:${{ env.DEPLOY_PATH }}/
          fi

      - name: Post-Deploy
        run: |
          ssh -p ${{ env.SSH_PORT }} ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            find . -type f -exec chmod 644 {} \;
            find . -type d -exec chmod 755 {} \;
            # Ensure storage directory structure exists but preserve existing files
            mkdir -p storage/app/public storage/framework/{sessions,views,cache/data} storage/logs
            chmod -R 775 storage bootstrap/cache
            php artisan config:clear
            php artisan route:clear
            php artisan view:clear
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            [ ! -f .env ] && cp .env.example .env && php artisan key:generate --force
            echo "Deployed to 501c3ers.com!"
          EOF